# **Ресурс "Логи" (logs)**

Ресурс **Логи** предназначен для получения логов работы системы.

Сервис сбора логов может работать в двух режимах: 
* режим совместимости с Loki
* нативный режим работы (самостоятельный сбор и накопление логов)

Режим работы указывается в настройках сервиса.

**Запросы**

## 1. Получение массива логов

**Назначение:** для получения массива логов за указанный временной диапазон

**Запрос** `/api/v1/logs/query_range`

**Тип запроса:** GET

**Параметры**:

**Обязательные параметры**:

| **имя поля** | **тип**    | **описание**                                                               |
|--------------|------------|----------------------------------------------------------------------------|
| `query`      | `string`   | cтрока запроса выражения Prometheus              |
| `start`      | `rfc3339`  | время начала диапазона            |
| `start`      | `unixtime` | время начала диапазона            |
| `end`        | `rfc3339`  | время окончания диапазона            |
| `end`        | `unixtime` | время окончания диапазона            |

**Необязательные параметры**:

| **имя поля** | **тип**    | **описание**                                                               |
|--------------|------------|----------------------------------------------------------------------------|
| `step`       | `integer`  | ширина шага логов в секундах (для матричных ответов)                      |
| `timeout`    | `integer`  | таймаут получения данных                                              |

Параметры `start` и `end` могут быть указаны как в виде `unixtime` так и в виде `rfc3339`

Если не указаны параметры `step` и `timeout` используются значения по умолчанию из настроек сервиса.

В нативном режиме строка запроса Loki поддерживается только в части указания `label` (например так `query={swarm_service="dcc7_agent", source="stderr"}`)

**Примеры:**

* `/api/v1/query_range?query={swarm_service="dcc7_agent", source="stderr"}&start=2025-01-30T00:40:51.781Z&end=2025-01-30T23:40:51.781Z`

**Ответ:**

```json
{
  "status": "success",
  "data": {
    "resultType": "streams",
    "result": [
      {
        "stream": {
          "container_name": "dcc7_queues.1.knrhmpywi3r2z2gbb1h3vxt45",
          "filename": "/var/log/docker/ef0ec469c493c9af82a84ca6d232c0f158383a39b60dd8013324f3acc904474c/json.log",
          "host": "dcc5",
          "source": "stderr",
          "swarm_service": "dcc7_queues",
          "swarm_stack": "dcc7"
        },
        "values": [
          [
            "1738241085769638560",
            "{\"app_layer\":\"service\",\"app_msg\":\"operation initiated\",\"app_oper\":\"GetQueueCounters\",\"app_sessid\":\"00000000-0000-0000-0000-000000000000\",\"app_usid\":\"00000000-0000-0000-0000-000000000000\",\"level\":\"info\",\"time\":\"2025-01-30T12:44:45.769504209Z\"}"
          ],
          [
            "1738241085380167255",
            "{\"ack\":0,\"app_layer\":\"mb\",\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":0,\"sent\":0,\"stream\":\"handlers:ac2b8c56-642e-4dba-bdb8-6ae0b09d76cd\",\"time\":\"2025-01-30T12:44:45.379805363Z\"}"
          ]
        ]
      },
      {
        "stream": {
          "container_name": "dcc7_postgres_dataspace.1.7b9txffukcmiwgdwjcxur7moq",
          "filename": "/var/log/docker/0cbd8ec72e55f283d505cbc0df9103db3a9e61e230168bb647a806c43140d2cc/json.log",
          "host": "dcc5",
          "source": "stderr",
          "swarm_service": "dcc7_postgres_dataspace",
          "swarm_stack": "dcc7"
        },
        "values": [
          [
            "1738241083556010254",
            "2025-01-30 12:44:43.555 UTC [38] STATEMENT:  INSERT INTO \"history\" (\"error\",\"traceid\",\"cacheid\",\"journal_id\",\"event\",\"rec_time\",\"id\",\"who\",\"reason\",\"queue_id\",\"queue_record_id\") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11),($12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22),($23,$24,$25,$26,$27,$28,$29,$30,$31,$32,$33),($34,$35,$36,$37,$38,$39,$40,$41,$42,$43,$44),($45,$46,$47,$48,$49,$50,$51,$52,$53,$54,$55),($56,$57,$58,$59,$60,$61,$62,$63,$64,$65,$66),($67,$68,$69,$70,$71,$72,$73,$74,$75,$76,$77),($78,$79,$80,$81,$82,$83,$84,$85,$86,$87,$88),($89,$90,$91,$92,$93,$94,$95,$96,$97,$98,$99),($100,$101,$102,$103,$104,$105,$106,$107,$108,$109,$110),($111,$112,$113,$114,$115,$116,$117,$118,$119,$120,$121),($122,$123,$124,$125,$126,$127,$128,$129,$130,$131,$132),($133,$134,$135,$136,$137,$138,$139,$140,$141,$142,$143),($144,$145,$146,$147,$148,$149,$150,$151,$152,$153,$154),($155,$156,$157,$158,$159,$160,$161,$162,$163,$164,$165),($166,$167,$168,$169,$170,$171,$172,$173,$174,$175,$176),($177,$178,$179,$180,$181,$182,$183,$184,$185,$186,$187),($188,$189,$190,$191,$192,$193,$194,$195,$196,$197,$198),($199,$200,$201,$202,$203,$204,$205,$206,$207,$208,$209),($210,$211,$212,$213,$214,$215,$216,$217,$218,$219,$220),($221,$222,$223,$224,$225,$226,$227,$228,$229,$230,$231),($232,$233,$234,$235,$236,$237,$238,$239,$240,$241,$242),($243,$244,$245,$246,$247,$248,$249,$250,$251,$252,$253),($254,$255,$256,$257,$258,$259,$260,$261,$262,$263,$264),($265,$266,$267,$268,$269,$270,$271,$272,$273,$274,$275),($276,$277,$278,$279,$280,$281,$282,$283,$284,$285,$286),($287,$288,$289,$290,$291,$292,$293,$294,$295,$296,$297),($298,$299,$300,$301,$302,$303,$304,$305,$306,$307,$308),($309,$310,$311,$312,$313,$314,$315,$316,$317,$318,$319),($320,$321,$322,$323,$324,$325,$326,$327,$328,$329,$330),($331,$332,$333,$334,$335,$336,$337,$338,$339,$340,$341),($342,$343,$344,$345,$346,$347,$348,$349,$350,$351,$352),($353,$354,$355,$356,$357,$358,$359,$360,$361,$362,$363),($364,$365,$366,$367,$368,$369,$370,$371,$372,$373,$374)"
          ],
          [
            "1738241083556000862",
            "2025-01-30 12:44:43.555 UTC [38] CONTEXT:  unnamed portal parameter $4 = ''"
          ],
          [
            "1738241083555958017",
            "2025-01-30 12:44:43.555 UTC [38] ERROR:  invalid input syntax for type uuid: \"\""
          ]
        ]
      },
      {
        "stream": {
          "container_name": "dcc7_gribs.1.b5tk8rwhu51hn2kwkgqihnahd",
          "filename": "/var/log/docker/1d918480cdce0ce523ec539c92326b7e06129c75929392458aeac5326fd0d67f/json.log",
          "host": "dcc5",
          "source": "stderr",
          "swarm_service": "dcc7_gribs",
          "swarm_stack": "dcc7"
        },
        "values": [
          [
            "1738241085557314051",
            "{\"ack\":51247,\"app_layer\":\"mb\",\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":51247,\"sent\":0,\"stream\":\"jrs\",\"time\":\"2025-01-30T12:44:45.557144142Z\",\"worker.ID\":\"0cf0dbf0-820b-4e05-a819-b6d1ec5652fc\",\"worker.Name\":\"uv_worker\"}"
          ],
          [
            "1738241085117038955",
            "{\"ack\":51391,\"app_layer\":\"mb\",\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":51391,\"sent\":0,\"stream\":\"jrs\",\"time\":\"2025-01-30T12:44:45.11690048Z\",\"worker.ID\":\"0cf0dbf0-820b-4e05-a819-b6d1ec5652fb\",\"worker.Name\":\"t_worker\"}"
          ]
        ]
      },
      {
        "stream": {
          "container_name": "dcc7_dataspace.1.fkrymow27627lt2sj2sqs2n02",
          "filename": "/var/log/docker/953d29369e72a7016494388e0fd2d4fda46142c50a744062326c9019562f1ea3/json.log",
          "host": "dcc5",
          "source": "stderr",
          "swarm_service": "dcc7_dataspace",
          "swarm_stack": "dcc7"
        },
        "values": [
          [
            "1738241085988081920",
            "{\"ack\":1043621,\"app_layer\":\"mb\",\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":1043621,\"sent\":0,\"stream\":\"hrs\",\"time\":\"2025-01-30T12:44:45.987774735Z\"}"
          ],
          [
            "1738241085987504867",
            "{\"ack\":102638,\"app_layer\":\"mb\",\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":102638,\"sent\":0,\"stream\":\"jrs\",\"time\":\"2025-01-30T12:44:45.987114609Z\"}"
          ],
          [
            "1738241082876706915",
            "{\"app_layer\":\"mb\",\"app_msg\":\"RSReceiver.startDeliveryLoop: got and treated 1 messages from Redis Streams\",\"level\":\"debug\",\"time\":\"2025-01-30T12:44:42.876450484Z\"}"
          ]
        ]
      },
      {
        "stream": {
          "container_name": "dcc7_datacomm.1.ij3pc7341bq2nmtegglpk55a5",
          "filename": "/var/log/docker/0220b4f509b745c96818a93578e316bad4893b71f1452d896a3e405be9b59cb7/json.log",
          "host": "dcc5",
          "source": "stderr",
          "swarm_service": "dcc7_datacomm",
          "swarm_stack": "dcc7"
        },
        "values": [
          [
            "1738241084796476953",
            "{\"ack\":0,\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":0,\"sent\":0,\"stream\":\"irs\",\"time\":\"2025-01-30T12:44:44.796016291Z\",\"worker.ID\":\"fd272230-bbc0-11ef-b070-02420a0001d0\",\"worker.Name\":\"Test link for Channel\",\"workerType\":\"SOCKET_SPECIAL\"}"
          ],
          [
            "1738241084792987983",
            "{\"ack\":0,\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":0,\"sent\":0,\"stream\":\"irs\",\"time\":\"2025-01-30T12:44:44.792736061Z\",\"worker.ID\":\"e20142e4-bbc0-11ef-b070-02420a0001d0\",\"worker.Name\":\"Test link for Channel\",\"workerType\":\"SOCKET_SPECIAL\"}"
          ],
          [
            "1738241084788806335",
            "{\"ack\":0,\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":0,\"sent\":0,\"stream\":\"irs\",\"time\":\"2025-01-30T12:44:44.788505094Z\",\"worker.ID\":\"893e400f-bbbc-11ef-852c-02420a0001cc\",\"worker.Name\":\"Test link for Channel\",\"workerType\":\"SOCKET_SPECIAL\"}"
          ],
          [
            "1738241084786842489",
            "{\"ack\":41807,\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":41807,\"sent\":0,\"stream\":\"p2:00000000-806a-11ed-a408-02420a00063b\",\"time\":\"2025-01-30T12:44:44.786386698Z\",\"worker.ID\":\"9077c5b1-3b09-4f28-9526-986bdf4c261c\",\"worker.Name\":\"test openMCEP to mitra5 7785\",\"workerType\":\"OPENMCEP\"}"
          ],
          [
            "1738241084786833643",
            "{\"ack\":13239,\"app_msg\":\"stats\",\"level\":\"info\",\"notack\":0,\"recv\":13239,\"sent\":0,\"stream\":\"p1:00000000-806a-11ed-a408-02420a00063b\",\"time\":\"2025-01-30T12:44:44.786345051Z\",\"worker.ID\":\"9077c5b1-3b09-4f28-9526-986bdf4c261c\",\"worker.Name\":\"test openMCEP to mitra5 7785\",\"workerType\":\"OPENMCEP\"}"
          ],
          [
            "1738241082876184665",
            "{\"app_msg\":\"put messsage into Redis Stream \\\"hrs\\\" with result \\\"1738241082875-0\\\"\",\"level\":\"debug\",\"module\":\"history\",\"time\":\"2025-01-30T12:44:42.875495987Z\",\"worker.ID\":\"9077c5b1-3b09-4f28-9526-986bdf4c261c\",\"worker.Name\":\"test openMCEP to mitra5 7785\",\"workerType\":\"OPENMCEP\"}"
          ]
        ]
      }
    ]
  }
}
```

**Возможные поля ответа:**

| **имя поля** | **тип**       | ** описание**                                                       |
|--------------|---------------|---------------------------------------------------------------------|
