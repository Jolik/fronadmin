# Ресурс "Таблица распределения" (правила) (rules)

Таблица распределения содержит записи с правилами (поле `rule`), которые применяются к проходящему через систему
контенту и сопоставлению логических каналов абонентам (поле `channels`), в очереди которых (каналов) распределяется
контент, удовлетворивший данному правилу.

Каждая запись таблицы распределения имеет включающие и исключающие фильтры.
Включающие фильтры являются обязательными.

**Включающий** фильтр означает, что запись будет записана в очереди указанных каналов (см. ниже) и потоки
соответствующих обработчиков.

**Исключающий** фильтр означает, что при срабатывании этого фильтра, обработка правила прекращается.

Сначала проверяются исключающие фильтры, затем - включающие.

Таким образом, имеем:

- OR между правилами;
- OR между фильтрами в массиве фильтров внутри одного правила;
- AND между условиями внутри одного фильтра из массива фильтров.

Для маршрутизации по обычным полям контента, например, по ключу распределения или по телу записи, в поле field
записывается название поля журнальной записи как есть – "field": "key".

Каждое правило имеет поле **rule.doubles**, которое если **НЕ** установлен, то в запись Таблицы распределения **НЕ**
могут быть распределены дублированные сообщения в случае срабатывания этого правила.

Если флаг **rule.doubles** установлен, то при срабатывании правила любые сообщения (в том числе и дублированные) могут
быть распределены в запись Таблицы распределения.

Пример правила:

```json
{
  "rule": {
    "position": 1,
    "priority": 2,
    "handlers": [
      "rpa"
    ],
    "channels": {
      "lch1": [],
      "lch2": [
        "ab1"
      ]
    },
    "doubles": true,
    "break": false,
    "excFilters": [
      {
        "conditions": [
          {
            "field": "who",
            "text": "summary",
            "type": "eq"
          }
        ],
        "disable": false
      }
    ],
    "incFilters": [
      {
        "conditions": [
          {
            "field": "format",
            "text": "HMS|WMO",
            "type": "regex"
          },
          {
            "field": "key",
            "text": "SN*",
            "type": "mask"
          },
          {
            "field": "who",
            "text": "prsstrip",
            "type": "eq"
          }
        ],
        "disable": false
      },
      {
        "conditions": [
          {
            "field": "format",
            "text": "XML|JSON",
            "type": "regex"
          }
        ],
        "disable": false
      }
    ]
  }
}


```

Ключи "field" и типы операций с ключами "types" могут быть следующих типов:

Поле field: 
* format
* key
* channel
* topic_hierarchy
* body
* bt
* first
* name
* who
* size

Поле type: 
* mask
* regex
* eq
* ne
* gt
* ge
* lt
* le
* dataset

фильтр типа `dataset` указывает на Набор данных. Если указан такой фильтр в
Таблице распределения, то алгоритм должен проверить вхождение контента в этот Набор данных.

фильтр типа `dataset` пока не поддерживается.

## 1. Список записей таблицы распределения

**Назначение:**   для получения списка записей таблицы распределения.

**Запрос:** `/api/v2/rules/list`

**Тип запроса:**  POST

**Параметры тела запроса:**

| **имя поля**  | **тип**    | **описание**                                                                            |
|---------------|------------|-----------------------------------------------------------------------------------------|
| `page`        |            | текущая страница для отображения                                                        | 
| `pagesize`    |            | кол-во элементов на странице для отображения. По умолчанию pagesize = 100               | 
| `ruid`        | `[]uuid`   | массив идентификатров записей для выдачи                                                |  
| `channel`     | `[]string` | массив (не путать с объектом в самом правиле!) имён каналов и алиасов правил для выдачи |
| `updatedFrom` | `unixtime` | время начала обновления Таблица распределения                                           | 
| `updatedTo`   | `unixtime` | время окончания обновления Таблица распределения                                        |
| `searchStr`   | `string`   | строка поиска по полям из `searchBy`                                                    | 
| `searchBy`    | `[]string` | устанавливает по каким полям делать поиск `searchStr`. Возможные значения:              | 
| `-caption`    | `opt`      | поиск по имени записей Таблица распределения                                            | 
| `order`       | `[]string` | устанавливает сортировку выдачи списка. Возможные значения в массиве:                   | 
| `-ruid`       | `opt`      | сортировка по ID Таблица распределения                                                  |  
| `-caption`    | `opt`      | сортировка по заголовку Таблица распределения                                           | 
| `-created`    | `opt`      | сортировка по времени создания записи об Таблица распределения                          | 
| `-updated`    | `opt`      | сортировка по времени обновления записи об Таблица распределения                        |  
| `orderDir`    | `string`   | устанавливает направление сортировки выдачи списка. `asc` или `desc`                    | 

**Тело запроса:**

```json
{
  "ruid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "channel": [
    "lch1",
    "mitra"
  ]
}
```

**Примеры:**  `/api/v2/rules/list`

**Ответ:**

```json
{
  "meta": {
    "code": 200,
    "rid": "058e6b2d-a3b6-11ed-a80b-02420a00015b",
    "time": "5.909"
  },
  "response": {
    "info": {
      "page": 0,
      "pagecount": 1,
      "pagesize": 100,
      "total": 4
    },
    "rules": [
      {
        "caption": "sample rule1",
        "ruid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "rule": {
          "doubles": true,
          "position": 3,
          "priority": 2,
          "handlers": [
            "rpa"
          ],
          "break": false,
          "channels": {
            "lch1": [],
            "lch2": [
              "ab1"
            ]
          },
          "incFilters": [
            {
              "conditions": [
                {
                  "field": "format",
                  "text": "GAO",
                  "type": "eq"
                }
              ],
              "disable": false
            }
          ],
          "excFilters": []
        },
        "created": 1671543109,
        "updated": 1671548483
      },
      {
        "caption": "sample rule2",
        "ruid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "rule": {
          "doubles": true,
          "position": 2,
          "priority": 2,
          "handlers": [
            "rpa"
          ],
          "break": false,
          "channels": {
            "lch3": [],
            "lch4": [
              "ab2"
            ]
          },
          "incFilters": [
            {
              "conditions": [
                {
                  "field": "format",
                  "text": "GAO",
                  "type": "eq"
                }
              ],
              "disable": false
            }
          ],
          "excFilters": []
        },
        "created": 1671543109,
        "updated": 1671548483
      },
      {
        "caption": "sample rule3",
        "ruid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "rule": {
          "doubles": true,
          "position": 4,
          "priority": 2,
          "handlers": [
            "rpa"
          ],
          "break": false,
          "channels": {
            "lch5": []
          },
          "incFilters": [
            {
              "conditions": [
                {
                  "field": "format",
                  "text": "GAO",
                  "type": "eq"
                }
              ],
              "disable": false
            }
          ],
          "excFilters": []
        },
        "created": 1671543109,
        "updated": 1671548483
      }
    ]
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**    | **описание**                                                                          |
|--------------|------------|---------------------------------------------------------------------------------------|
| `page`       | `string`   | текущий номер страницы (дублирует параметр запроса)                                   |
| `pagecount`  | `string`   | общее число страниц (зависит от размера pagesize)                                     |
| `pagesize`   | `string`   | сколько элементов выдавать на странице (дублирует параметр запроса)                   |
| `total`      | `string`   | всего элементов в таблице                                                             |
| `ruid`       | `string`   | уникальный идентификатор записи Таблицы распределения                                 |
| `caption`    | `string`   | название записи Таблица распределения                                                 |
| `created`    | `unixtime` | Unix время даты создания                                                              |
| `updated`    | `unixtime` | Unix время даты обновления                                                            |
| `incFilters` | `[]struct` | массив включающих фильтров                                                            |
| `excFilters` | `[]struct` | массив исключающих фильтров                                                           |
| `doubles`    | `bool`     | распределять ли дублированный контент, если сработало это правило                     |
| `position`   | `integer`  | позиция правила для сортировки                                                        |
| `priority`   | `integer`  | новый приоритет контента (1-4, 0 - задерживать, -1 - не менять)                       |
| `handlers`   | `json`     | список имён обработчиков                                                              |
| `break`      | `bool`     | проверять ли другие записи Таблицы распределения, если сработало  это правило         |
| `channels`   | `json`     | объект, сопоставляющий имена каналов и алиасов для распределения - массивам абонентов |

## 2. Информация по записи Таблицы распределения

**Назначение:**   Получение полной информации о записи Таблицы распределения

**Запрос:** `/api/v2/rules/:ruid`

**Тип запроса:** GET

**Возможные параметры**:

**Примеры:**  `/api/v2/rules/a7fb3ae9-806a-11ed-a408-02420a00063a`

**Ответ:**

```json

{
  "meta": {
    "code": 200,
    "rid": "865a50a4-a3bb-11ed-a80b-02420a00015b",
    "time": "6.978"
  },
  "response": {
    "rule": {
      "caption": "sample rule1",
      "ruid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
      "rule": {
        "doubles": true,
        "position": 1,
        "priority": 2,
        "handlers": [
          "rpa"
        ],
        "break": false,
        "channels": {
          "lch1": [],
          "lch2": [
            "ab1"
          ]
        },
        "incFilters": [
          {
            "conditions": [
              {
                "field": "format",
                "text": "GAO",
                "type": "eq"
              },
              {
                "field": "name",
                "text": "SN*",
                "type": "mask"
              },
              {
                "field": "who",
                "text": "000*",
                "type": "mask"
              }
            ],
            "disable": false
          },
          {
            "conditions": [
              {
                "field": "format",
                "text": "GAO",
                "type": "eq"
              },
              {
                "field": "name",
                "text": "AA*",
                "type": "mask"
              },
              {
                "field": "who",
                "text": "001*",
                "type": "mask"
              }
            ],
            "disable": false
          }
        ],
        "excFilters": []
      },
      "created": 1671543109,
      "updated": 1671548483
    }
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**    | **описание**                                                                          |
|--------------|------------|---------------------------------------------------------------------------------------|
| `ruid`       | `string`   | уникальный идентификатор записи Таблицы распределения                                 |
| `caption`    | `string`   | название записи Таблица распределения                                                 |
| `created`    | `unixtime` | Unix время даты создания                                                              |
| `updated`    | `unixtime` | Unix время даты обновления                                                            |
| `incFilters` | `[]struct` | массив включающих фильтров                                                            |
| `excFilters` | `[]struct` | массив исключающих фильтров                                                           |
| `doubles`    | `bool`     | распределять ли дублированный контент, если сработало это правило                     |
| `position`   | `integer`  | позиция правила для сортировки                                                        |
| `priority`   | `integer`  | новый приоритет контента (1-4, 0 - задерживать, -1 - не менять)                       |
| `handlers`   | `json`     | список имён обработчиков                                                              |
| `break`      | `bool`     | проверять ли другие записи Таблицы распределения, если сработало  это правило         |
| `channels`   | `json`     | объект, сопоставляющий имена каналов и алиасов для распределения - массивам абонентов |

## 3. Добавить запись Таблицы распределения

**Назначение:**   для добавления новой записи Таблица распределения.

**Запрос:** `/api/v2/rules/new`

**Тип запроса:** POST

**Тело запроса**:

```json

{
  "caption": "sample rule1",
  "ruid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
  "rule": {
    "doubles": true,
    "priority": 2,
    "handlers": [
      "rpa"
    ],
    "break": false,
    "channels": {
      "lch1": [],
      "lch2": [
        "ab1"
      ]
    },
    "incFilters": [
      {
        "conditions": [
          {
            "field": "format",
            "text": "GAO",
            "type": "eq"
          },
          {
            "field": "name",
            "text": "SN*",
            "type": "mask"
          },
          {
            "field": "who",
            "text": "000*",
            "type": "mask"
          }
        ],
        "disable": false
      },
      {
        "conditions": [
          {
            "field": "format",
            "text": "GAO",
            "type": "eq"
          },
          {
            "field": "name",
            "text": "AA*",
            "type": "mask"
          },
          {
            "field": "who",
            "text": "001*",
            "type": "mask"
          }
        ],
        "disable": false
      }
    ],
    "excFilters": []
  }
}

```

Каналы и алиасы (поле `rule.channels`) и обработчики (поле `rule.handlers`) в которые предполагается
распределять создаваемым правилом должны существовать на момент выполнения запроса.

**Обязательные поля запроса**:

| **имя поля** | **тип**    | **описание**                                                                          |
|--------------|------------|---------------------------------------------------------------------------------------|
| `rule`       | `json`     | правило записи Таблицы распределения                                                  |
| `channels`   | `json`     | объект, сопоставляющий имена каналов и алиасов для распределения - массивам абонентов |
| `incFilters` | `[]struct` | массив включающих фильтров                                                            |

**Необязательные поля запроса**:

| **имя поля** | **тип**    | **описание**                                                                  |
|--------------|------------|-------------------------------------------------------------------------------|
| `ruid`       | `string`   | уникальный идентификатор записи Таблицы распределения                         |
| `caption`    | `string`   | название записи Таблица распределения                                         |
| `doubles`    | `bool`     | распределять ли дублированный контент, если сработало это правило             |
| `position`   | `integer`  | позиция правила для сортировки                                                |
| `priority`   | `integer`  | новый приоритет контента (1-4, 0 - задерживать, -1 - не менять)               |
| `handlers`   | `json`     | список имён обработчиков                                                      |
| `break`      | `bool`     | проверять ли другие записи Таблицы распределения, если сработало  это правило |
| `excFilters` | `[]struct` | массив исключающих фильтров                                                   |

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "ruid": "e18a3dc0-704b-11e7-8cf7-a6006ad3dba0"
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**  | **описание**                                           |
|--------------|----------|--------------------------------------------------------|
| `ruid`       | `string` | уникальный идентификатор записи Таблицы распределения. |

## 4. Обновить запись Таблицы распределения

**Назначение:**   для обновления параметров записи Таблица распределения.

**Запрос:** `/api/v2/rules/:ruid/update`

**Возможные параметры**: нет

**Тип запроса:** POST

**Пример:**

`/api/v2/rules/c4527e88-6fe3-11e7-b6d0-a6006ad3dba0/update`

**Тело запроса: **

```json

{
  "caption": "sample rule1",
  "rule": {
    "doubles": true,
    "position": 1,
    "priority": 2,
    "handlers": [
      "rpa"
    ],
    "break": false,
    "channels": {
      "lch1": [],
      "lch2": [
        "ab1"
      ]
    },
    "incFilters": [
      {
        "conditions": [
          {
            "field": "format",
            "text": "GAO",
            "type": "eq"
          },
          {
            "field": "name",
            "text": "SN*",
            "type": "mask"
          },
          {
            "field": "who",
            "text": "000*",
            "type": "mask"
          }
        ],
        "disable": false
      },
      {
        "conditions": [
          {
            "field": "format",
            "text": "GAO",
            "type": "eq"
          },
          {
            "field": "name",
            "text": "AA*",
            "type": "mask"
          },
          {
            "field": "who",
            "text": "001*",
            "type": "mask"
          }
        ],
        "disable": false
      }
    ],
    "excFilters": []
  }
}

```

Каналы и алиасы (поле `rule.channels`) и обработчики (поле `rule.handlers`) в которые предполагается
распределять обновляемым правилом должны существовать на момент выполнения запроса.

**Возможные поля запроса**:

| **имя поля** | **тип**  | **описание**                          |
|--------------|----------|---------------------------------------|
| `caption`    | `string` | название записи Таблица распределения |
| `rule`       | `json`   | правило записи Таблицы распределения  |

**Ответ:**

```json

{
  "meta": {},
  "response": {}
}

```

## 5. Удалить запись из Таблицы распределения

**Назначение:** для удаления записи из Таблицы распределения

**Запрос** `/api/v2/rules/:ruid/remove`

где `:ruid` – идентификатор записи

**Тип запроса:** POST

**Пример:**  `/api/v2/rules/dea50f0c-f55f-4063-9f17-e45ae8c03bce/remove

**Ответ:**

```json

{}

```