# Ресурс "Абоненты" (abonents)

Ресурс "Абоненты" нужны для того, чтобы можно было передавать при распределении некоторые атрибуты, которые могут быть
использованы в линке при передаче контента

У каждого Абонента есть поле "attr" куда записываются атрибуты абонента для передачи контента.

## Формат поля `attr` для абонента

```json
{
  "name": "TTAAii",
  "email": "first@sample.com"
}
```

Например, если в таблице распределения в поле "channels" указано: 

```json
{
  "lch1": [
    "ab1"
  ],
  "lch2": [
    "ab2",
    "ab3"
  ]
}
```

то:

* при распределении в канал "lch1" в очередь должно быть записано поле `abonents.[].attr` из абонента "ab1"
* при распределении в канал "lch2" в очередь должно быть записано поле `abonents.[].attr` из абонента "ab2" и абонента "ab3"

Для примера выше это выглядит вот так:

```json
{
  "content": {
    "bt": "message",
    "double": "8214368d-a8ca-11ef-a28e-02420a0000e8",
    "hash": "2e98fad1798cb35bfe612fdc8c5a0c8e",
    "jrid": "99a8a4cb-a8ca-11ef-a28e-02420a0000e8",
    "key": "FTCH14SCSC",
    "name": "FTCH14 SCSC 211200",
    "size": 835,
    "who": "router"
  },
  "created_at": 1732277358,
  "expires_at": 1732363758,
  "priority": 2,
  "qid": "00000000-806a-11ed-a408-02420a00063b",
  "qrid": "99a8ce32-a8ca-11ef-a28e-02420a0000e8",
  "read": false,
  "status": "put",
  "abonents": [
    {
      "name": "ab2", 
      "attr": { 
          "name": "TTAAii",
          "email": "first@sample.com"
      }
    },
    {
      "name": "ab3", 
      "attr": { 
          "name": "TTAAii",
          "email": "first@sample.com"
      }
    }
  ]
}
```

Теперь линк, при получении этой записи из очереди, может применять указанные атрибуты для передачи контента (например,
линк типа SMTP client может передавать контент адресату "email": "first@sample.com")

Кроме этого возможно и такое написание: `mail_ch(#dima@mhsr.mecom.ru)`, где `mail_ch` - канал, а `#dima@mhsr.mecom.ru`
атрибут (без абонента!)

В этом случае, абонент отсутствует и при распределении в канал `"mail_ch"` в очередь должно быть записано поле 
`abonents.[].attr` с атрибутом `"main"`

Это выглядит вот так:

```json
{
  "content": {
    "bt": "message",
    "double": "8214368d-a8ca-11ef-a28e-02420a0000e8",
    "hash": "2e98fad1798cb35bfe612fdc8c5a0c8e",
    "jrid": "99a8a4cb-a8ca-11ef-a28e-02420a0000e8",
    "key": "FTCH14SCSC",
    "name": "FTCH14 SCSC 211200",
    "size": 835,
    "who": "router"
  },
  "created_at": 1732277358,
  "expires_at": 1732363758,
  "priority": 2,
  "qid": "00000000-806a-11ed-a408-02420a00063b",
  "qrid": "99a8ce32-a8ca-11ef-a28e-02420a0000e8",
  "read": false,
  "status": "put",
  "abonents": [
    {
      "name": "", 
      "attr": { 
          "main": "dima@mhsr.mecom.ru"
      }
    }
  ]
}
```

В случае если атрибутов несколько, то создается несколько записей атрибутов "main"

Например, для случая `mail_ch(#dima@mhsr.mecom.ru, #fedor@mhsr.mecom.ru)` записываем поле `abonents` так:

```json
[
  {
    "name": "",
    "attr": {
      "main": "dima@mhsr.mecom.ru"
    }
  },
  {
    "name": "",
    "attr": {
      "main": "fedor@mhsr.mecom.ru"
    }
  }
]
```

## Замечание по итогам созвона 25.12.2024, от Артемия:

Поле `channels` внутри абонента является информативным. Оно может расходиться с настройками распределения
и не играет никакой роли. Расхождение этого поля с конфигурацией распределения не имеет значения.
При распределении в лог пишем `warning` если каналы внутри абонента не соответствуют конфигурации распределения.

## 1. Список Абонентов

**Назначение:**   для получения списка Абонентов.

**Запрос:** `/api/v2/abonents/list`

**Тип запроса:**  POST

**Параметры тела запроса:**

| **имя поля**  | **тип**    | **описание**                                                               |
|---------------|------------|----------------------------------------------------------------------------|
| `page`        |            | текущая страница для отображения                                           | 
| `pagesize`    |            | кол-во элементов на странице для отображения. По умолчанию pagesize = 100  | 
| `abid`        | `[]uuid`   | массив идентификатров записей для выдачи                                   | 
| `name`        | `[]string` | массив наименования Абонентов для выдачи                                   | 
| `channel`     | `[]string` | массив каналов Абонентов для выдачи                                        | 
| `updatedFrom` | `unixtime` | время начала обновления Абонентов                                          | 
| `updatedTo`   | `unixtime` | время окончания обновления Абонентов                                       |
| `searchStr`   | `string`   | строка поиска по полям из `searchBy`                                       | 
| `searchBy`    | `[]string` | устанавливает по каким полям делать поиск `searchStr`. Возможные значения: | 
| `-name   `    | `opt`      | поиск по имени записей Абонентов                                           | 
| `-caption`    | `opt`      | поиск по заголовку записей Абонентов                                       | 
| `order`       | `[]string` | устанавливает сортировку выдачи списка. Возможные значения в массиве:      | 
| `-abid`       | `opt`      | сортировка по ID Абонентов                                                 | 
| `-name`       | `opt`      | сортировка по наименованию Абонентов                                       | 
| `-caption`    | `opt`      | сортировка по заголовку Абонентов                                          | 
| `-created`    | `opt`      | сортировка по времени создания записи об Абонентов                         | 
| `-updated`    | `opt`      | сортировка по времени обновления записи об Абонентов                       | 
| `orderDir`    | `string`   | устанавливает направление сортировки выдачи списка. `asc` или `desc`       | 

**Тело запроса:**

```json
{
  "abid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "channel": [
    "lch1",
    "mitra"
  ]
}
```

**Примеры:**  `/api/v2/abonents/list`

**Ответ:**

```json
{
  "meta": {
    "code": 200,
    "rid": "058e6b2d-a3b6-11ed-a80b-02420a00015b",
    "time": "5.909"
  },
  "response": {
    "info": {
      "page": 0,
      "pagecount": 1,
      "pagesize": 100,
      "total": 4
    },
    "abonents": [
      {
        "name": "Ab1",
        "caption": "Abonent1",
        "abid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "channels": [
          "lch1",
          "mitra"
        ],
        "created": 1671543109,
        "updated": 1671548483
      },
      {
        "name": "Ab2",
        "caption": "Abonent2",
        "abid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "channels": [
          "lch1",
          "mitra"
        ],
        "created": 1671543109,
        "updated": 1671548483
      },
      {
        "name": "Ab3",
        "caption": "Abonent3",
        "abid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
        "channels": [
          "lch1",
          "mitra"
        ],
        "created": 1671543109,
        "updated": 1671548483
      }
    ]
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**    | **описание**                                                        |
|--------------|------------|---------------------------------------------------------------------|
| `page`       | `string`   | текущий номер страницы (дублирует параметр запроса)                 |
| `pagecount`  | `string`   | общее число страниц (зависит от размера pagesize)                   |
| `pagesize`   | `string`   | сколько элементов выдавать на странице (дублирует параметр запроса) |
| `total`      | `string`   | всего элементов в таблице                                           |
| `abid`       | `string`   | уникальный идентификатор Абонента                                   |
| `name`       | `string`   | уникальное имя Абонента                                             |
| `caption`    | `string`   | название Абонента                                                   |
| `created`    | `unixtime` | Unix время даты создания                                            |
| `updated`    | `unixtime` | Unix время даты обновления                                          |
| `channels`   | `json`     | список имен каналов, соответствующих Абоненту                       |

## 2. Информация по Абоненту

**Назначение:**   Получение полной информации о Абоненте

**Запрос:** `/api/v2/abonents/:abid`

**Тип запроса:** GET

**Возможные параметры**:

**Примеры:**  `/api/v2/abonents/a7fb3ae9-806a-11ed-a408-02420a00063a`

**Ответ:**

```json

{
  "meta": {
    "code": 200,
    "rid": "865a50a4-a3bb-11ed-a80b-02420a00015b",
    "time": "6.978"
  },
  "response": {
    "abonent": {
      "name": "Ab1",
      "caption": "Abonent1",
      "abid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
      "channels": [
        "lch1",
        "mitra"
      ],
      "attr": {
        "name": "TTAAii",
        "email": "first@sample.com"
      },
      "created": 1671543109,
      "updated": 1671548483
    }
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**    | **описание**                                  |
|--------------|------------|-----------------------------------------------|
| `abid`       | `string`   | уникальный идентификатор Абонента             |
| `name`       | `string`   | уникальное имя Абонента                       |
| `caption`    | `string`   | название Абонента                             |
| `channels`   | `json`     | список имен каналов, соответствующих Абоненту |
| `attr`       | `json`     | набор атрибутов Абонента                      |
| `created`    | `unixtime` | Unix время даты создания                      |
| `updated`    | `unixtime` | Unix время даты обновления                    |

## 3. Добавить Абонента

**Назначение:**   для добавления нового Абонента.

**Запрос:** `/api/v2/abonents/new`

**Тип запроса:** POST

**Тело запроса**:

```json

{
  "name": "Ab1",
  "caption": "Abonent1",
  "abid": "a7fb3ae9-806a-11ed-a408-02420a00063a",
  "channels": [
    "lch1",
    "mitra"
  ],
  "attr": {
    "name": "TTAAii",
    "email": "first@sample.com"
  }
}

```

**Обязательные поля запроса**:

| **имя поля** | **тип**  | **описание**                                  |
|--------------|----------|-----------------------------------------------|
| `name`       | `string` | уникальное имя Абонента                       |
| `channels`   | `json`   | список имен каналов, соответствующих Абоненту |
| `attr`       | `json`   | набор атрибутов Абонента                      |

**Необязательные поля запроса**:

| **имя поля** | **тип**  | **описание**                      |
|--------------|----------|-----------------------------------|
| `abid`       | `string` | уникальный идентификатор Абонента |
| `caption`    | `string` | название Абонента                 |

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "abid": "e18a3dc0-704b-11e7-8cf7-a6006ad3dba0"
  }
}

```

**Поля ответа:**

| **имя поля** | **тип**  | **описание**                       |
|--------------|----------|------------------------------------|
| `abid`       | `string` | уникальный идентификатор Абонента. |

## 4. Обновить Абонента

**Назначение:**   для обновления параметров Абонента.

**Запрос:** `/api/v2/abonents/:abid/update`

**Возможные параметры**: нет

**Тип запроса:** POST

**Пример:**

`/api/v2/abonents/c4527e88-6fe3-11e7-b6d0-a6006ad3dba0/update`

**Тело запроса: **

```json

{
  "caption": "Abonent1",
  "channels": [
    "lch1",
    "mitra"
  ],
  "attr": {
      "name": "TTAAii",
      "email": "first@sample.com"
  }
}

```

**Возможные поля запроса**:

| **имя поля** | **тип**  | **описание**                                  |
|--------------|----------|-----------------------------------------------|
| `caption`    | `string` | название Абонента                             |
| `channels`   | `json`   | список имен каналов, соответствующих Абоненту |
| `attr`       | `json`   | набор атрибутов Абонента                      |

**Ответ:**

```json

{
  "meta": {},
  "response": {}
}

```

## 5. Удалить запись об Абоненте

**Назначение:** для удаления записи об Абоненте

**Запрос** `/api/v2/rou/:abid/remove`

где `:abid` – идентификатор записи

**Тип запроса:** POST

**Пример:**  `/api/v2/abonents/dea50f0c-f55f-4063-9f17-e45ae8c03bce/remove

**Ответ:**

```json

{
  "meta": {},
  "response": {}
}

```