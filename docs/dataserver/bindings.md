# Ресурс "Привязки" (binding)

Ресурс содержит список **Привязок** (binding) зарегистрированных в системе.

Привязки нужны для связи сущностей `entity` с внешними метаданными `urn` системы. Например, Привязка может связать
Источники (sources) с некоторой внешней записью Метаданных.

Что конкретно привязывает Привязка определяется типом Привязки `type`. Например, для Источников тип привязки `type`=`sid`

Ввиду того, что в контексте метаданных каждая сущность может иметь свой идентификатор, в Привязка добавлено поле `index`

Каждая запись имеет следующие поля:

* `bid` - уникальный идентификатор записи о Привязки
* `compid` - идентификатор организации, к которой относится Привязка (пока не используется)
* `entity` - идентификатор сущности, которая связывается с метаданными
* `type` - тип Привязки (может быть "sid", "oid", "dstid")
* `urn` - идентификатор метаданных с которым связывается сущность
* `index` - индекс сущности `entity` в контексте метаданных `urn`

Формат поля `data`:

```json
{
  "def": "Описание Привязки",
  "attr": {}
}
```

**Запросы**

## 1. Список Привязок

**Назначение:** для получения списка зарегистрированных в системе Привязок.

**Запрос** `/api/v2/metadata/bindings/list`

**Тип запроса:** POST

**Параметры**: нет

**Тело запроса:**

```json
{
  "page": 1,
  "pagesize": 100,
  "bid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "compid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "updateFrom": 23457625678,
  "updateTo": 23457625678,
  "searchStr": "bla-bla-bla",
  "searchBy": [
    "index"
  ],
  "order": [
    "created"
  ],
  "orderDir": "asc",
  "flag": [
    "all"
  ]
}
```

**Возможные параметры тела запроса**:

| **имя поля**  | **тип**    | **описание**                                                               |
|---------------|------------|----------------------------------------------------------------------------|
| `page`        |            | текущая страница для отображения                                           | 
| `pagesize`    |            | кол-во элементов на странице для отображения. По умолчанию pagesize = 100  |
| `bid`         | `[]uuid`   | список идентификаторов Привязок                                            |
| `compid`      | `[]uuid`   | список идентификаторов организаций, которым принадлежат Привязки           |
| `entity`      | `[]string` | список идентификаторов сущностей, по которым необходимо выдать Привязки    |
| `type`        | `[]string` | список типов Привязок которые необходимо выдать                            |
| `urn`         | `[]string` | список идентификаторов метаданных, по которым необходимо выдать Привязки   |
| `index`       | `[]string` | список индексов сущностей, по которым необходимо выдать  Привязки          |
| `updatedFrom` | `unixtime` | выдача по времени обновления записи                                        |
| `searchStr`   | `string`   | строка поиска по полям из `searchBy`                                       | 
| `searchBy`    | `[]string` | устанавливает по каким полям делать поиск `searchStr`. Возможные значения: | 
| `-entity`     | `opt`      | поиск по идентификатору сущности                                           |
| `-urn`        | `opt`      | поиск по идентификатору метаданных                                         |
| `-index`      | `opt`      | поиск по индексу Привязка                                                  |
| `order`       | `[]string` | устанавливает сортировку выдачи списка. Возможные значения в массиве:      | 
| `-compid`     | `opt`      | сортировка по организации, которой принадлежит Привязка                    | 
| `-entity`     | `opt`      | сортировка по идентификатору сущности                                      |
| `-type`       | `opt`      | сортировка по типу Привязки                                                |
| `-created`    | `opt`      | сортировка по времени создания                                             | 
| `-updated`    | `opt`      | сортировка по времени обновления                                           | 
| `orderDir`    | `string`   | устанавливает направление сортировки выдачи списка. `asc` или `desc`       | 

**Пример:**

* `/api/v2/metadata/bindings/list`

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "bindings": {
      "info": {
        "page": 0,
        "pagecount": 1,
        "pagesize": 100,
        "total": 3
      },
      "items": [
        {
          "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
          "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
          "entity": "RU77-012345-0000",
          "type": "sid",
          "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
          "index": "XXX",
          "data": {
            "def": "Описание Привязки"
          },
          "created": 1531398947,
          "updated": 76597656795
        },
        {
          "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
          "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
          "entity": "RU77-012345-0000",
          "type": "sid",
          "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
          "index": "YYY",
          "data": {
            "def": "Описание Привязки"
          },
          "created": 1531398947,
          "updated": 76597656795
        }
      ]
    }
  }
}

```

**Возможные поля ответа:**

| **имя поля** | **тип**       | **описание**                                                        |
|--------------|---------------|---------------------------------------------------------------------|
| `page`       | `string`      | текущий номер страницы (дублирует параметр запроса)                 |
| `pagecount`  | `string`      | общее число страниц (зависит от размера pagesize)                   |
| `pagesize`   | `string`      | сколько элементов выдавать на странице (дублирует параметр запроса) |
| `total`      | `string`      | всего элементов в таблице                                           |
| `bid`        | `uuid`        | уникальный идентификатор Привязка                                   |
| `compid`     | `uuid`        | идентификатор организации, которой принадлежит Привязка             |
| `entity`     | `string[255]` | идентификатор сущности                                              |
| `type`       | `string[8]`   | тип Привязки                                                        |
| `urn`        | `string[255]` | идентифиукатор метаданных                                           |
| `index`      | `string[64]`  | индекс сущности в контексте указанных метаданных                    |

## 2. Информация по указанной Привязке

**Назначение:** для получения информации по указанной Привязке.

**Запрос** `/api/v2/metadata/bindings/BIND_ID`

где `BIND_ID` – идентификатор Привязка

**Тип запроса:** GET

**Возможные параметры:**  нет

**Пример:**  `/api/v2/metadata/bindings/dea50f0c-f55f-4063-9f17-e45ae8c03bce`

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "binding": {
      "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
      "entity": "RU77-012345-0000",
      "type": "sid",
      "index": "XXX",
      "data": {
        "def": "Описание Привязки"
      },
      "created": 1531398947,
      "updated": 76597656795
    }
  }
}

```

**Возможные поля ответа:**

| **имя поля** | **тип**       | **описание**                                            |
|--------------|---------------|---------------------------------------------------------|
| `bid`        | `uuid`        | уникальный идентификатор Привязка                       |
| `compid`     | `uuid`        | идентификатор организации, которой принадлежит Привязка |
| `entity`     | `string[255]` | идентификатор сущности                                  |
| `type`       | `string[8]`   | тип Привязки                                            |
| `urn`        | `string[255]` | идентификатор метаданных                                |
| `index`      | `string[64]`  | индекс сущности в контексте указанных метаданных        |
| `data`       | `json`        | данные Привязка                                         |

## 3. Создать новую запись о Привязке

**Назначение:** для регистрации новой Привязки

Если при создании Привязки не укзывается поле `type` то считается что это привязка для Истоничка (`type`=`sid`)

При создании Привязки должны выполняться проверки для каждого `type`:
* `sid` = поле `entity` должно совпадать с одним из `sid` системы 
* `oid` = поле `entity` должно совпадать с одним из `oid` системы 
* `dstid` = поле `entity` должно совпадать с одним из `dsid` системы 

**Запрос** `/api/v2/metadata/bindings/new`

**Тип запроса:** POST

**Пример:**  `/api/v2/metadata/bindings/new`

Передаваемые данные:

```json

{
  "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
  "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
  "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
  "entity": "RU77-012345-0000",
  "type": "sid",
  "index": "XXX",
  "data": {
    "def": "Описание Привязки"
  }
}

```

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "bid": "dea50f0c-f55f-4063-9f17-e45ae8c03bce"
  }
}

``` 

**Обязательные параметры:**

| **имя поля** | **тип**       | **описание**                                            |
|--------------|---------------|---------------------------------------------------------|
| `compid`     | `uuid`        | идентификатор организации, которой принадлежит Привязка |
| `entity`     | `string[255]` | идентификатор сущности                                  |
| `index`      | `string[64]`  | индекс сущности в контексте указанных метаданных        |
| `urn`        | `string[255]` | идентифиукатор метаданных                               |

**Необязательные параметры:**

| **имя поля** | **тип** | **описание**                      |
|--------------|---------|-----------------------------------|
| `type`       | `string[8]` | тип Привязки                                                        |
| `bid`        | `uuid`  | уникальный идентификатор Привязка |
| `data`       | `json`  | данные Привязка                   |

Если `type` не указано, то считается что `type` = `sid`

**Поля ответа:**

| **имя поля** | **тип** | **описание**                      |
|--------------|---------|-----------------------------------|
| `bid`        | uuid    | уникальный идентификатор Привязка |

## 4. Создать новые записи о Привязках

**Назначение:** для групповой регистрации новых Привязок

Если при создании не указывается поле `type` то считается что это привязка для Истоничка (`type`=`sid`)

При создании Привязки должны выполняться проверки для каждого `type`:
* `sid` = поле `entity` должно совпадать с одним из `sid` системы 
* `oid` = поле `entity` должно совпадать с одним из `oid` системы 
* `dstid` = поле `entity` должно совпадать с одним из `dsid` системы 

**Запрос** `/api/v2/metadata/bindings/newgroup`

**Тип запроса:** POST

**Пример:**  `/api/v2/metadata/bindings/newgroup`

Передаваемые данные:

```json

{
  "bindings": [
    {
      "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
      "entity": "RU77-012345-0000",
      "type": "sid",
      "index": "XXX",
      "data": {
        "def": "Описание Привязки"
      }
    },
    {
      "bid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
      "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
      "entity": "RU77-012345-0000",
      "type": "sid",
      "index": "XXX",
      "data": {
        "def": "Описание Привязки"
      }
    }
  ]
}

```

**Ответ:**

```json
{
  "meta": {},
  "response": {
    "bindings": [
        "aaaa1232-ed42-11ce-bacd-00aa00000062",
        "aaaa1232-ed42-11ce-bacd-00aa00000063",
        "aaaa1232-ed42-11ce-bacd-00aa00000064"
    ]
  }
}
``` 

**Обязательные параметры:**

| **имя поля** | **тип**       | **описание**                                            |
|--------------|---------------|---------------------------------------------------------|
| `bindings`   | `json`        | массив привязок для создания                            |
| `compid`     | `uuid`        | идентификатор организации, которой принадлежит Привязка |
| `entity`     | `string[255]` | идентификатор сущности                                  |
| `index`      | `string[64]`  | индекс сущности в контексте указанных метаданных        |
| `urn`        | `string[255]` | идентифиукатор метаданных                               |

**Необязательные параметры:**

| **имя поля** | **тип**     | **описание**                      |
|--------------|-------------|-----------------------------------|
| `type`       | `string[8]` | тип Привязки                      |
| `bid`        | `uuid`      | уникальный идентификатор Привязка |
| `data`       | `json`      | данные Привязка                   |

Если `type` не указано, то считается что `type` = `sid`

**Поля ответа:**

| **имя поля** | **тип** | **описание**                      |
|--------------|---------|-----------------------------------|
| `bid`        | uuid    | уникальный идентификатор Привязка |

## 5. Обновить информацию об Привязки

**Назначение:** для обновления информации об Привязки. Обновляются указанные в запросе поля.

Невозможно обновить поля `bid`, `compid` и `type` 

**Запрос** `/api/v2/metadata/bindings/BIND_ID/update`

где `BIND_ID` – идентификатор Привязка

**Тип запроса:** POST

**Пример:**  `/api/v2/metadata/bindings/dea50f0c-f55f-4063-9f17-e45ae8c03bce/update`

Передаваемые данные:

```json
{
  "urn": "rn:x-wmo:md:int.wmo.wis::HRJO98RJTD",
  "entity": "RU77-012345-0000",
  "index": "XXX",
  "data": {
    "def": "Описание Привязки"
  }
}
```

**Ответ:**

```json

{}

```

**Возможные поля запроса:**

| **имя поля** | **тип**       | **описание**                                     |
|--------------|---------------|--------------------------------------------------|
| `entity`     | `string[255]` | идентификатор сущности                           |
| `urn`        | `string[255]` | идентифиукатор метаданных                        |
| `index`      | `string[64]`  | индекс сущности в контексте указанных метаданных |
| `data`       | `json`        | данные Привязка                                  |

## 6. Удалить запись о Привязке

**Назначение:** для удаления ранее архивированной записи ое Привязке

**Запрос** `/api/v2/metadata/bindings/BIND_ID/remove`

где `BIND_ID` – идентификатор Привязка

**Тип запроса:** POST

**Параметры запроса:**

| **имя поля** | **тип** | **описание**                      |
|--------------|---------|-----------------------------------|
| `bid`        | `uuid`  | уникальный идентификатор Привязка |

**Пример:**  `/api/v2/metadata/bindings/dea50f0c-f55f-4063-9f17-e45ae8c03bce/remove`

**Ответ:**

```json

{}

```
