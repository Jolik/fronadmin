**Профиль** - настройка для выдачи/получения сообщений в линках в зависимости от правил описанных в нём.  
Например профиль может содержать условие "если во входящем письме адрес получателя = `123@mail.com` то сообщение отправить в fta_XML".  
Профили храняться отдельно от settings в модуле ACL и подгружаются линками при старте. Следовательно нужно перезапускать линк после внесения изменений в профили.  
В датаком так же есть api для работы с профилями который проксирует запросы к [api профилей ACL](http://dev.modext.ru:8929/wis/doc-for-wis/-/blob/master/API/acl/profiles.md).
  
Каждая запись профиля имеет следующие поля:

* `prid` - уникальный идентификатор записи о Профиле
* `compid` - идентификатор организации, к которой относится Профиль
* `owner` - идентификатор владельца Профиля (например идентификатор линка)
* `name` - наименование Профиля (никнейм)
* `descr` - дескриптор Профиля
* `data` - данные связанные с Профилем
* `body` - содержит структуры rule&play. подробнее [тут](profile_bodies.md)

пример минимального профиля линка socket special:  
```json
{
    "prid": "22b95670-84d5-11f0-a8c0-02420a00012d",
    "compid": "85697f9f-b80d-4668-8ed2-2f70ed825eee",
    "owner": "90d77ba1-85f2-4dc9-8019-d4f1a00e4476",
    "name": "профиль default SS XML",
    "descr": "default",
    "data": {},
    "body": {
        "rule": {
            "incFilters": [
                {
                    "conditions": [
                        {
                            "text": "*",
                            "type": "mask",
                            "field": "ip"
                        }
                    ]
                }
            ]
        },
        "play": {
            "fta": [
                "fta_XML"
            ]
        }
    },
    "created": 1756471139,
    "updated": 1756471139,
    "archived": null
}
```
настроен так что сообщения от всех клиентов отправляются в fta_XML


## API datacomm для работы с профилями линков


## 1. Список профилей линка (LIST)

**Назначение:**   для получения списка Профилей линка. примечание: поле body не выдаётся

**Запрос:** `/api/v1/links/<lid>/profiles/list`  
где `<lid>` – идентификатор линка  

**Тип запроса:**  POST

**Тело запроса:**  
```json
{
  "page": 1,
  "pagesize": 100,
  "prid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "compid": [
    "6016ebf8-81a3-11e7-bb31-be2e44b06b34",
    "6016ebf8-81a3-11e7-bb31-be2e44b06b35"
  ],
  "descr": [
    "demo@example.com",
    "demo1@example.com"
  ],
  "updateFrom": 46346364,
  "updateTo": 46346364,
  "searchStr": "bla-bla-bla",
  "search": [
    "name"
  ],
  "order": [
    "owner"
  ],
  "orderDir": "asc",
  "flag": [
    "all"
  ]
}
```

**Возможные параметры тела запроса**:

| **имя поля**   | **тип**    | **описание**                                                               |
|----------------|------------|----------------------------------------------------------------------------|
| `page`         |            | текущая страница для отображения                                           | 
| `pagesize`     |            | кол-во элементов на странице для отображения. По умолчанию pagesize = 100  |
| `prid`         | `[]uuid`   | список идентификаторов Профилей                                       |
| `compid`       | `[]uuid`   | список идентификаторов организаций, которым принадлежат Профиле       |
| `descr`        | `[]string` | список дескрипторов Профилей                                       | 
| `updatedFrom`  | `unixtime` | выдача по времени обновления записи                                        |
| `searchStr`    | `string`   | строка поиска по полям из `search`                                         | 
| `search`       | `[]string` | устанавливает по каким полям делать поиск `searchStr`. Возможные значения: | 
| `-name`        | `opt`      | поиск по имени Профиля                                                |
| `-descr`       | `opt`      | поиск по дескриптору Профиля                                                | 
| `order`        | `[]string` | устанавливает сортировку выдачи списка. Возможные значения в массиве:      | 
| `-compid`      | `opt`      | сортировка по организации, которой принадлежит Профиль                | 
| `-name`        | `opt`      | сортировка по имени                                                        | 
| `-owner`       | `opt`      | сортировка по владельцу                                                       | 
| `-descr`       | `opt`      | сортировка по дескриптору Профиля                                           | 
| `-created`     | `opt`      | сортировка по времени создания                                             | 
| `-updated`     | `opt`      | сортировка по времени обновления                                           | 
| `orderDir`     | `string`   | устанавливает направление сортировки выдачи списка. `asc` или `desc`       | 
| `flag `        | `[]string` | массив флагов. Значения:                                                   | 
| `-all`         | `opt`      | отображать активные записи + архивные                                      |
| `-archiveonly` | `opt`      | отобразить только архивные записи                                          |




**Пример:**  
POST `http://213.167.42.170:8000/datacomm/api/v1/links/44444444-22dd-4fa7-95b2-92766df3f699/profiles/list`  
пустое тело  

**Ответ:**

```json
{
  "meta": {
    "code": 0,
    "rid": "4c770f1d-4ba7-4be1-8835-0ab59e048471",
    "time": "3.760ms"
  },
  "response": {
    "profiles": {
      "info": {
        "page": 1,
        "pagecount": 1,
        "pagesize": 100,
        "total": 1,
        "count": 1
      },
      "items": [
        {
          "prid": "55555555-a54f-11f0-a7c4-02420a00013b",
          "compid": "85697f9f-b80d-4668-8ed2-2f70ed825eee",
          "owner": "44444444-22dd-4fa7-95b2-92766df3f699",
          "name": "",
          "descr": "профиль",
          "data": {},
          "created": 1760042072,
          "updated": 1760042072
        }
      ]
    }
  }
}
```

**Поля ответа:**

| **имя поля** | **тип**    | **описание**                                                        |
|--------------|------------|---------------------------------------------------------------------|
| `page`       | `string`   | текущий номер страницы (дублирует параметр запроса)                 |
| `pagecount`  | `string`   | общее число страниц (зависит от размера pagesize)                   |
| `pagesize`   | `string`   | сколько элементов выдавать на странице (дублирует параметр запроса) |
| `total`      | `string`   | всего элементов в таблице                                           |
| `prid`        | `string`   | уникальный идентификатор профиля Профиля                              |
| `descr`       | `string`   | дескриптор Профиля                                               |
| `name`       | `string`   | наименование Профиля                                               |
| `created`    | `unixtime` | Unix время даты создания                                            |
| `updated`    | `unixtime` | Unix время даты обновления                                          |



## 2. Информация по профилю линка  

**Назначение:**   Получение полной информации о Профиле  

**Запрос:** `/api/v1/links/<lid>/profiles/<prid>`  
где `<lid>` – идентификатор линка  
где `<prid>` – идентификатор профиля линка

**Тип запроса:** GET  

**Возможные параметры**:  

**Пример:**  
GET `http://213.167.42.170:8000/datacomm/api/v1/links/4444444-22dd-4fa7-95b2-92766df3f699/profiles/55555555-a54f-11f0-a7c4-02420a00013b`  

**Ответ:**  
 ```json
 {
  "meta": {
    "code": 0,
    "rid": "04e8973c-b816-45cb-81a6-34a087fd38de",
    "time": "2.934ms"
  },
  "response": {
    "profile": {
      "prid": "55555555-a54f-11f0-a7c4-02420a00013b",
      "compid": "85697f9f-b80d-4668-8ed2-2f70ed825eee",
      "owner": "44444444-22dd-4fa7-95b2-92766df3f699",
      "name": "",
      "descr": "профиль",
      "data": {},
      "body": {
        "play": {
          "fta": [
            "fta_TLF"
          ],
          "priority": 4
        },
        "rule": {
          "incFilters": [
            {
              "conditions": [
                {
                  "field": "ip",
                  "text": "*",
                  "type": "mask"
                }
              ]
            }
          ],
          "position": 100
        }
      },
      "created": 1760042072,
      "updated": 1760042072
    }
  }
}
 ```

 **Поля ответа:**  
 то же что в 1 плюс body  
 | **имя поля** | **тип**    | **описание**                                                      |
|--------------|------------|-------------------------------------------------------------------|
| `body`        | `string`   | настройки Профиля                              |




# 3. Добавить профиль линка  (NEW)

**Назначение:**   для добавления нового Профиля линка.

**Запрос:** `/api/v1/links/<lid>/profiles/new`  
где `<lid>` – идентификатор линка  

**Тип запроса:** POST

**Тело запроса:**  
```json
{
    "prid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
    "compid": "c2caaa-ed42-11ce-bacd-00aa0057b111",
    "name": "Профиль файлов ВМО",
    "descr": "stream1@mecom.ru",
    "data": {...},
    "body": {...}
}
```
**Обязательные поля запроса**:

| **имя поля** | **тип**  | **описание**          |
|--------------|----------|-----------------------|
| `descr`       | `string` | дескриптор Профиля |
| `body`   | `string`   | настройки Профиля                                               |

**Ответ:**

```json
{
  "meta": {},
  "response": {
    "prid": "e18a3dc0-704b-11e7-8cf7-a6006ad3dba0"
  }
}
```

**Поля ответа:**

| **имя поля** | **тип**  | **описание**                            |
|--------------|----------|-----------------------------------------|
| `prid`        | `string` | уникальный идентификатор записи Профиля. |





## 4. Обновить профиль линка (UPDATE)

**Назначение:**   для обновления параметров профиля линка.

**Запрос:** `/api/v1/links/<lid>/profiles/<prid>/update`  
где `<lid>` – идентификатор линка  
где `<prid>` – идентификатор профиля линка  

**Возможные параметры**: нет

**Тип запроса:** POST

**Пример:**  
POST `http://213.167.42.170:8000/datacomm/api/v1/links/4444444-22dd-4fa7-95b2-92766df3f699/profiles/55555555-a54f-11f0-a7c4-02420a00013b/update`  

**Тело запроса:**  
поля которые следует изменить
```json
{
    "name": "Профиль файлов ВМО",
    "body": {
      ...
    }
}
```

Поле `descr` изменить нельзя

**Возможные поля запроса**:

| **имя поля** | **тип**    | **описание**                                                      |
|--------------|------------|-------------------------------------------------------------------|
| `descr`       | `string`   | идентификатор Профиля                                               |
| `body`   | `string`   | настройки Профиля                                               |

**Ответ:**

```json
{
  "meta": {},
  "response": {}
}
```



## 5. Архивировать запись о Профиле линка (ARCHIVE)

**Назначение:** для архивации записи о Профиле линка

**Запрос** `/api/v1/links/<lid>/profiles/archive?prid=<prid>`  
где `<lid>` – идентификатор линка  
где `<prid>` – идентификатор профиля линка

**Тип запроса:** POST

**Параметры запроса:**

**Пример:**  
POST `http://213.167.42.170:8000/datacomm/api/v1/links/4444444-22dd-4fa7-95b2-92766df3f699/profiles/archive?prid=55555555-a54f-11f0-a7c4-02420a00013b`  
пустое тело  

**Ответ:**

```json
{
  "meta": {},
  "response": {}
}
```


## 6. Восстановить запись о профиле линка (RESTORE)

**Назначение:** для восстановления ранее архивированной записи о Профиле линка

**Запрос** `/api/v1/links/<lid>/profiles/restore?prid=<prid>`  
где `<lid>` – идентификатор линка  
где `<prid>` – идентификатор профиля линка


**Тип запроса:** POST

**Параметры запроса:**

**Пример:**  
POST `http://213.167.42.170:8000/datacomm/api/v1/links/4444444-22dd-4fa7-95b2-92766df3f699/profiles/restore?prid=55555555-a54f-11f0-a7c4-02420a00013b`  
пустое тело  


**Ответ:**

```json
{
  "meta": {},
  "response": {}
}
```



## 7. Удалить профиль линка (REMOVE)

**Назначение:** для удаления записи из профиля линка

**Запрос** `/api/v1/links/<lid>/profiles/rem?prid=<prid>`  
где `<lid>` – идентификатор линка  
где `<prid>` – идентификатор профиля линка


**Тип запроса:** POST

**Пример:**  
POST `http://213.167.42.170:8000/datacomm/api/v1/links/4444444-22dd-4fa7-95b2-92766df3f699/profiles/rem?prid=55555555-a54f-11f0-a7c4-02420a00013b`  
пустое тело  

**Ответ:**

```json
{
  "meta": {},
  "response": {}
}
```
