unit ParentFormUnit;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics,
  Controls, Forms, uniGUITypes, uniGUIAbstractClasses,
  uniGUIClasses, uniGUIForm,
  EntityUnit, EntityBrokerUnit,
  ParentEditFormUnit,
  RestBrokerBaseUnit, BaseRequests;

type
  ///  базовая форма с редактором и брокером
  TParentForm = class(TUniForm)
    procedure UniFormCreate(Sender: TObject);
    procedure UniFormDestroy(Sender: TObject);
  private
    ///  брокер для доступа к API - потомок должен инициировать поле на функционального брокера
    FBroker: TEntityBroker;
    FRestBroker: TRestBrokerBase;
    ///  форма для редактирования сущности - потом должен инициировать поле на функциональный класс
    FEditForm : TParentEditForm;

  protected
    procedure NewCallback(ASender: TComponent; AResult: Integer);
    procedure UpdateCallback(ASender: TComponent; AResult: Integer);

    ///  функция для обновления компонент на форме
    procedure Refresh(const AId: String = ''); virtual; abstract;

    ///  функция для создания нужного брокера потомком
    ///  поток должен переопределить функцию чтобы создавался нужный брокер
    function CreateBroker(): TEntityBroker; virtual; abstract;
    // New REST-broker factory (requests создаёт брокер)
    function CreateRestBroker(): TRestBrokerBase; virtual;

    ///  функиця для создания нужной формы редактирвоания
    ///  поток должен переопределить функцию чтобы создавалась нужная форма редактирвоания
    function CreateEditForm(): TParentEditForm; virtual; abstract;

  public
    ///  брокер для доступа к API - потомок содать и вернуть ссылку на нужный брокер
    ///  в наследуемой функции CreateBroker
    property Broker: TEntityBroker read FBroker;
    property RestBroker: TRestBrokerBase read FRestBroker;
    ///  форма для редактирования сущности - потомок должен создать и вернуть
    ///  ссылку на нужную форму в наследуемой функции CreateEditForm
    property EditForm: TParentEditForm read FEditForm;
    procedure PrepareEditForm(isEditMode:boolean=false);
  end;

function ParentForm: TParentForm;

implementation

{$R *.dfm}

uses
  MainModule, uniGUIApplication, HttpClientUnit;

{  TParentForm }

procedure TParentForm.NewCallback(ASender: TComponent;
  AResult: Integer);
var
  LId : string;
  res : boolean;
  ReqNew: TReqNew;
  JsonRes: TJSONResponse;

begin
  ///
  ///  если модальное окно закрылось через ОК
  if AResult <> mrOk then exit;
  if Assigned(FRestBroker) then
  begin
    res := False;
    ReqNew := FRestBroker.CreateReqNew();
    if not Assigned(EditForm) or not Assigned(EditForm.Entity) then exit;

    ReqNew.ApplyFromEntity(EditForm.Entity);
    JsonRes := nil;
    try
      JsonRes := FRestBroker.New(ReqNew);
      if not Assigned(JsonRes) then
        Exit;

      if JsonRes.StatusCode <> 201 then
      begin
        MessageDlg(Format('Создание не удалось. HTTP %d'#13#10'%s',
          [JsonRes.StatusCode, JsonRes.Response]), TMsgDlgType.mtWarning, [mbOK], nil);
        res := False;
        Exit;
      end
      else
      begin
        res := True;
      end;
    finally
      JsonRes.Free;
    end;
  end;

end;

procedure TParentForm.UpdateCallback(ASender: TComponent;
  AResult: Integer);
var
  LId : string;
  res : boolean;
  ReqUpd: TReqUpdate;
  JsonRes: TJSONResponse;

begin
  ///  если модальное окно закрылось через ОК
  if AResult = mrOk then
  begin
    /// считываем из окна отредатикрованный класс сущности
    ///  и пытаемся обновить на сервере
    ///  если все ок, то в ответ вернется обноленный класс сущности
    if Assigned(FRestBroker) then
    begin
      res := False;
      ReqUpd := FRestBroker.CreateReqUpdate();
      if Assigned(ReqUpd) then
      begin
        try
          if Assigned(EditForm) and Assigned(EditForm.Entity) then
            ReqUpd.Id := EditForm.Entity.Id;

          if Assigned(ReqUpd.ReqBody) and (EditForm.Entity is TFieldSet) then
            TFieldSet(ReqUpd.ReqBody).Assign(TFieldSet(EditForm.Entity));

          JsonRes := FRestBroker.Update(ReqUpd);
          try
            if Assigned(JsonRes) and (JsonRes.StatusCode = 200) then
              res := True
            else
            begin
              if Assigned(JsonRes) then
                MessageDlg(Format('Обновление не удалось. HTTP %d'#13#10'%s',
                  [JsonRes.StatusCode, JsonRes.Response]), TMsgDlgType.mtWarning, [mbOK], nil)
              else
                MessageDlg('Обновление не удалось: пустой ответ', TMsgDlgType.mtWarning, [mbOK], nil);
              res := False;
            end;
          finally
            JsonRes.Free;
          end;
        except
          on E: Exception do
            res := False;
        end;
      end
      else
        res := False;
    end
    else
      res := Broker.Update(EditForm.Entity);
    ///  если обновить на сервере не удалось, то сообщаем об этом
    if not res then
    begin
/// !!!     ShowMessage()
      exit;
    end
    else
    begin
      ///  если сущность на сервре создалась то
      ///  обрабатываем результат
      ///  обновляем таблицу с указанием новой сущности
///!!!      Refresh(LEntity.Id);
        Refresh();
    end;
  end;
end;

procedure TParentForm.UniFormCreate(Sender: TObject);
begin
  ///   создаем брокера
  FBroker := CreateBroker();
  FRestBroker := CreateRestBroker();
  ///   создаем форму редактирования
  /// 2025-10-16 Папков Александр. Тут не нужно создавать форму редактирования
  /// Ее нужно создавать по месту применения
  // FEditForm := CreateEditForm();
end;

procedure TParentForm.UniFormDestroy(Sender: TObject);
begin
  FreeAndNil(Broker);
// надо удалять или не нужнО? FreeAndNil(EditForm);
end;

procedure TParentForm.PrepareEditForm(isEditMode:boolean=false);
begin
  FEditForm := CreateEditForm();
  FEditForm.IsEdit:= isEditMode;
end;

function ParentForm: TParentForm;
begin
  Result := TParentForm(UniMainModule.GetFormInstance(TParentForm));
end;

{ Default implementations for REST factories }

function TParentForm.CreateRestBroker: TRestBrokerBase;
begin
  Result := nil;
end;

end.

